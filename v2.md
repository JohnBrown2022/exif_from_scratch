# V2 架构草案：统一 Node/Layer 渲染模型 + 插件化水印

> 目标：把“模板元素”和“特殊水印（拓扑/二维码/胶片噪点等）”统一到同一套 **Render Node / Layer** 模型里，形成稳定的渲染管线与可扩展插件协议；UI 侧用“图层 + 动态属性面板”降低认知负担并提升扩展性。

## 1. 关键问题（V1 为什么会越来越难维护）
- **模板与水印是两套系统**：模板走 `WatermarkTemplate.render(...)`，拓扑水印是 `renderer.ts` 里的硬编码分支。
- **状态碎片化**：模板 id、背景、拓扑水印参数、导出参数等分散在多个 state/props；每加一种水印要接入多处。
- **UI 难以扩展**：InspectorPanel 是固定表单；新增插件意味着手写一套 JSX 与状态 wiring。

V2 的核心就是：**所有可渲染东西都变成 Layer(Node)**，渲染器只做“遍历 layers → 查 type → sanitize → resolveRect → render”。

## 2. 统一数据模型：ProjectJson v2（Unified Node System）
> 项目/模板最终都是 JSON（可持久化、可分享）。

### 2.1 顶层结构（Project）
当前实现（已落地）在 `src/core/project/types.ts`：

- `ProjectJsonV2`
  - `version`: `"2.0"`
  - `canvas`: 渲染画布规格（模板模式 / 固定尺寸）+ background
  - `nodes`: 图层数组（渲染栈，顺序即绘制顺序）

> 命名上文档里叫 `layers` 也可以；代码里目前叫 `nodes`（语义等价：图层节点）。

### 2.2 节点结构（RenderNodeJson）
- `id`: 稳定 id（用于 UI 选择、持久化、diff）
- `type`: 如 `core/image`、`plugin/topology_mountain`、`legacy/template_layer`
- `enabled`: 是否绘制（用于图层开关）
- `clip`: `none | photo`（是否裁剪到照片区域）
- `layout`: `NodeLayout`（位置与尺寸）
- `props`: 插件/节点私有参数（由插件 `sanitizeProps` 负责清洗）

### 2.3 布局（NodeLayout）
当前实现（已落地）在 `src/core/project/layout.ts`：
- 支持 `px` 与百分比（`"12%"`）
- 支持两类定位：
  - `kind: "rect"`：x/y/width/height
  - `kind: "anchor"`：anchor + offset + width/height
- `relativeTo`: `canvas | photo`（相对画布或相对照片区域）

> 后续 UI 可以先用更友好的“锚点+偏移/拖拽”，底层仍然落盘为 `layout` JSON。

## 3. 插件化系统：NodeTypeDef（Plugin Protocol）
核心接口在 `src/core/project/registry.ts`：

每个节点类型（内置或插件）注册为 `NodeTypeDef`：
- `type`: 唯一标识（例如 `plugin/topology_mountain`）
- `meta`: UI 展示用元数据（name/description/icon）
- `fields`: `SettingsField[]`（用于动态生成 Inspector 表单）
- `defaultProps`: 新建节点时的初始 props
- `sanitizeProps(raw)`: 对 JSON props 做容错与归一化（避免 NaN / undefined 崩溃）
- `resolveRect(...)`: 当节点没有显式 layout 或需要“环境相关布局”时，计算 rect（避免核心渲染器写死特例）
- `render(ctx, node, env)`: 实际 Canvas 绘制逻辑

### 3.1 已实现的内置节点
已落地在 `src/core/project/builtins.ts`：
- `legacy/template_layer`：过渡期兼容旧模板引擎（backdrop/overlay）
- `core/image`：绘制照片层（contain/cover + rotation + 圆角裁剪）
- `plugin/topology_mountain`：拓扑山水徽（生成式 stamp）

### 3.2 字段 Schema（SettingsField）
已在 `src/core/project/registry.ts` 扩展：
- slider / toggle / select / text
- 支持 `showWhen` / `disabledWhen` / `hint`

`plugin/topology_mountain` 已补齐字段定义（可用 schema 自动生成 UI）。

## 4. 统一渲染管线：compile → render
主入口在 `src/core/project/pipeline.ts`：

### 4.1 compileProject()
- 根据 `canvas.mode` 决定画布尺寸来源：
  - `template`: 复用现有模板的 `getLayout()` 得到 canvasWidth/canvasHeight/imageRect/drawMode/cornerRadius
  - `fixed_size`: 直接用固定宽高
- 计算 `photoRect`（当 contain 时为实际绘制到的图片矩形）
- 遍历 nodes：
  - `sanitizeProps`
  - `resolveNodeRect(layout)` 或 `def.resolveRect(...)`
  - 生成 `CompiledNode[]`

### 4.2 renderProject()
- 画 background（none / color / blur）
- 逐层渲染 nodes（按数组顺序）
- 支持 `clip: photo`（裁剪到照片区域）
- 若模板需要 palette：在 `core/image` 之后抽色并缓存到 env（供 template overlay 使用）

## 5. 兼容策略：Legacy Adapter（先打通，再迁移）
过渡层在 `src/core/project/legacyAdapter.ts`：
- 仍然使用现有模板系统（JSON template engine）
- 把当前 UI 的状态（template/background/topology）映射成一个 ProjectJsonV2：
  1) `legacy/template_layer` (backdrop)
  2) `core/image`
  3) `plugin/topology_mountain`（可选，clip=photo）
  4) `legacy/template_layer` (overlay)

并且 `src/core/render/renderer.ts` 已改为：
- `renderWatermark()` 内部创建 legacy project → 调 `renderProject()`
- 外部 API 不变（Preview/Export 无需改）

## 6. UI/UX 演进（从固定表单到“图层 + 动态属性面板”）
### 6.1 Layer Manager（图层面板）
目标交互：
- 展示渲染栈（底图 → 效果 → 文本/Logo → …）
- 选择、隐藏、删除、拖拽排序
- 添加新图层：`+` → 选择插件类型（拓扑/二维码/胶片噪点…）

### 6.2 Dynamic Inspector（动态属性面板）
机制：
- 点击某个图层 → 读取该 node type 的 `fields` → 自动生成表单
- 少数特殊节点可提供自定义 Inspector（可选扩展）

当前进度（已落地一个垂直切片）：
- 新增了 `图层（实验）` Tab：`src/app/panels/InspectorPanel/LayersTab.tsx`
- `plugin/topology_mountain` 的参数面板由 `SettingsFieldsForm` 根据 schema 生成

### 6.3 Interactive Preview（交互式预览）
下一步目标：
- 在预览区直接拖拽水印节点（更新 node.layout 或更新 positionMode/x/y）
- “Ghost/虚线框”模式：添加节点时先显示占位框，确认后执行耗时绘制

## 7. 迁移路线（建议）
1) **已完成**：V2 渲染管线 + legacy adapter 打通（不改 UI）
2) **进行中**：图层概念进入 UI（Layers Tab）+ schema 驱动的属性面板
3) 逐步把模板从 `legacy/template_layer` 拆解为 `core/text/core/logo/core/stack/...` 节点（每个模板逐个迁移）
4) 接入更多插件：QRCode / FilmGrain / DateStamp / 自定义图片水印…
5) 预设系统升级：Preset = ProjectJson + ExportOptions（一个对象即可完整复现）

## 8. 未决问题（需要你拍板）
1) Project JSON 是否统一用 `layers` 字段命名（目前实现为 `nodes`）？
2) 拓扑水印的 seed 逻辑落盘策略：存 `seed`（已解析）还是存 `seedMode+manualSeed`（可复现）？
3) UI 侧“模板”在 V2 里是否仍然作为一种节点（推荐：是，直到完全迁移）？

