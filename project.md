# 项目计划：纯本地相机参数水印（EXIF）Web App

> 本计划基于 `init.md` 的调研结论：**纯前端、本地处理、可离线**的“相机参数水印”Web App 可行；工程难点主要在 **HEIC/HEIF 兼容**、**批量性能与内存**，以及“Canvas 重编码会丢元数据”带来的用户预期管理。

---

## 0. 已确定的选型（根据你的回复）

- 应用：**Vite + React + TypeScript**
- 渲染：**Canvas 合成**
- 导出：**PNG/JPEG**，并允许用户选择 **JPEG quality**
- 明确不做：**导出 JPEG 的 EXIF 复制/回写**

---

## 0.1 依赖与工具清单（建议，按 v1/v2 分层）

> 这里只列“推荐组合”，不是硬要求；你也可以选择尽量零依赖。

### v1（核心闭环）
- EXIF 读取：`exifr`（或 `ExifReader` 二选一）
- 模板校验：`zod`（用于模板 JSON 的 schema 校验与版本升级）
- 批量 ZIP（可选 v1.5）：`fflate`（纯前端压缩）

### v2+（进阶）
- PWA：`vite-plugin-pwa`
- HEIC 转码兜底：按实现选择（WASM/纯前端转换库）

### 工程质量（建议）
- 代码风格：`eslint` + `prettier`

---

## 1. 产品目标（你想做的事）

做一个**不上传图片、无后端**的 Web App：

- 导入照片（单张/批量）
- 本地读取 EXIF（相机型号、镜头、焦段、快门、ISO、光圈、时间、GPS 等可选）
- 套用水印模板（多套预设 + 可调参数）
- 导出成新图（PNG/JPEG；可调 JPEG quality；批量导出；可选 ZIP）
- 可选：PWA 离线可用

**导出后的元数据策略（重要）**
- v1 起即明确：**导出图片不保留 EXIF 元数据**（Canvas 重编码的自然结果，也是隐私友好默认行为）
- 在 UI/导出设置里显式提示，避免用户误以为“导出后仍能看到拍摄参数/GPS”

**非目标（建议 v1 不做）**
- 账号体系/云同步/在线模板市场（保持“纯本地”）
- 复杂的“类 PS”自由编辑（先做可用模板闭环）
- 导出文件保留/回写 EXIF（包含 GPS 等敏感信息）

---

## 2. v1 范围（先交付可用闭环）

### v1 必须有
- 导入：拖拽 + 文件选择（支持多选）
- EXIF 读取：至少读取拍摄时间、相机型号、镜头（若有）、焦段、快门、光圈、ISO（字段缺失要有兜底显示）
- 模板：≥4 套预设（例如：底部黑条、左下角信息块、胶片风、极简角标）
- 预览：选中图片 → 即时预览水印效果
- 导出：单张导出 PNG/JPEG（**明确不保留 EXIF**；提供 JPEG quality 选择）
- 批量：任务队列 + 进度 + 失败可重试（先支持 10–50 张的可用体验）
- 隐私声明：明确“图片不上传”，并提示 EXIF 可能含 GPS

### v1 不做但要预留接口
- PWA 离线
- HEIC/HEIF 转码兜底
- Worker/OffscreenCanvas 性能通道

---

## 3. 技术架构（纯前端）

### 3.1 数据流（核心闭环）
1) 选择/拖拽文件 → 生成任务列表（File/Blob）
2) 解码图片（优先 `createImageBitmap`）→ 生成预览尺寸位图
3) 读取 EXIF → 归一化为内部数据结构（缺失字段给默认值/占位）
4) 选择模板 + 参数（字体、颜色、布局、是否显示某些字段）
5) 渲染输出（Canvas/DOM）→ 得到导出 Blob
6) 保存/下载（单张/批量 ZIP）

### 3.2 本地存储（建议）
- `IndexedDB`：保存模板配置、用户预设、最近使用参数、（可选）批量任务记录
- `localStorage`：少量偏好（主题、默认导出尺寸/质量）

---

## 4. 关键技术点拆解

### 4.1 EXIF 读取（v1）
目标：稳定读取常用字段，并处理 Orientation、缺失/异常值。

建议策略：
- 选一个成熟的前端 EXIF 库（例如 `exifr` / `ExifReader` 这类）做读取与字段映射
- 做一层 **字段归一化**：把厂商差异/格式差异统一为内部结构，例如：
  - `cameraMake`, `cameraModel`
  - `lensModel`
  - `focalLengthMm`
  - `shutterSeconds`（或字符串 `1/200`）
  - `aperture`（f/1.8）
  - `iso`
  - `takenAt`（ISO 时间）
  - `gps`（可选）

### 4.2 渲染（水印合成）
渲染方案已确定为 **Canvas 合成**。无论选哪种，都建议：
- v1 先固定：**图片缩放策略**（最长边/原尺寸/自定义）
- 模板参数尽量“可序列化”：可存为 JSON 预设

### 4.3 导出（PNG/JPEG）与质量
- v1：直接导出（**不保留 EXIF**，并在导出设置里提示原因：隐私与技术链路）
- 导出设置建议（v1 就做）：
  - `格式`：PNG / JPEG
  - `JPEG quality`：0.6–0.95（默认 0.92，可做成滑杆或下拉“高/中/低”）
  - `导出尺寸`：原尺寸 / 适配最长边（例如 2048/4096）/ 自定义
  - `文件命名`：支持简单模板（如 `{date}_{camera}_{index}.jpg`）
  - `JPEG 背景色`：当模板含透明区域时，给用户一个背景色（默认黑/白）

### 4.4 HEIC/HEIF（v2+）
建议组合策略：
- 若浏览器原生可解码：直接走 `createImageBitmap`
- 否则：WASM/纯前端转码兜底（转 JPEG/PNG），并在 UI 提示“转码会增加耗时/内存”

### 4.5 批量与性能（v1 可做轻量版，v2 做硬核版）
- v1：并发池（并发 1–2），限制单次最大张数/提示风险
- v2：把“解码 + 渲染 + 导出”放到 Worker（优先 OffscreenCanvas，fallback 主线程）
- 内存策略：尽量不长期持有大位图；导出后释放引用；预览用缩略图

### 4.6 离线 PWA（v2）
- Service Worker precache：让应用在无网时仍能启动
- 缓存策略：只缓存静态资源；**不要默认缓存用户图片**

---

## 5. 选型对比（留档；本项目已选 React + Canvas）

这里把“框架”分成两类：**应用 UI 框架** 与 **渲染/合成方案**。两者都可能影响开发速度与后续扩展。

### 5.1 应用 UI 框架（推荐先在这一步做选择）

**A) Vite + React + TypeScript（推荐默认）**
- 优点：生态最大；组件/状态管理/表单/拖拽/虚拟列表选择多；招聘与长期维护友好
- 缺点：样板稍多；需要你对 React 习惯用法熟悉

**B) Vite + Vue 3 + TypeScript**
- 优点：模板语法直观；组件与样式组织较顺滑；上手快
- 缺点：生态规模略小于 React（但对本项目通常够用）

**C) Vite + Svelte（或 SvelteKit 纯静态导出）**
- 优点：包体与运行时开销小；写起来轻；交互体验好
- 缺点：团队协作与生态相对小；一些库的“第一选择”仍是 React/Vue

**D) Vanilla + Web Components（或 Lit）**
- 优点：最轻；框架依赖最少；更“长期不变”
- 缺点：你要自己搭更多工程能力（状态、路由、组件库），总体开发成本更高

> 结论建议：如果你想“快交付 + 生态稳”，选 A 或 B；如果你更在意“轻量 + 简洁”，选 C；只有在你非常抗拒框架时才选 D。

### 5.2 渲染/合成方案（影响导出稳定性与性能）

**1) Canvas 合成（推荐默认）**
- 思路：把原图画到 Canvas，再绘制文字/图形，直接 `toBlob` 导出
- 优点：导出链路最直接；性能可控；适合批量与 Worker/OffscreenCanvas
- 缺点：复杂排版（自动换行、富文本、图标对齐）需要自己处理

**2) DOM/CSS 预览 + 截图导出（例如 dom-to-image/html-to-image 类）**
- 优点：排版自由（CSS 即所见即所得）；做模板编辑器更爽
- 缺点：导出稳定性/清晰度/跨浏览器差异更大；批量与 Worker 化通常更难

**3) SVG 模板 + 位图合成**
- 优点：模板可结构化；文本与图形可控；适合做“模板文件格式”
- 缺点：最终仍要 rasterize；处理字体与布局也有坑

> 结论建议：v1 选 1) Canvas 合成，先把闭环做稳；v3 若要做可视化模板编辑器，再评估 2)/3)。

### 5.3 本项目最终选型（落地）

- UI：React（函数组件 + hooks），尽量少引入重状态库（v1 用 React state/context 足够）
- 预览与导出：同一套 Canvas 渲染器（预览用缩放输出，导出用目标尺寸输出）
- 批量：并发池（默认并发 1–2），可在设置里开放高级选项
- 不做 EXIF 回写：导出物默认无元数据，UI 明确说明

## 6. 里程碑（从 0 到可用，再到进阶）

### M0：工程脚手架（0.5–1 天）
- 初始化：Vite + React + TS
- 约定：目录结构、模板 JSON 版本号、导出文件命名规则、错误处理规范
- 工具链（建议）：ESLint + Prettier；只在本地依赖（不需要后端）
- UI 基础：页面布局（左侧列表/中间预览/右侧参数），可复用的 Slider/Select/Switch

验收：能本地启动开发服务器；能构建静态产物。

### M1：单张导入 + EXIF 读取 + 预览（1–3 天）
- 文件导入：input + 拖拽
- EXIF 读取：解析并展示字段表（用于调试）
- 预览：显示图片缩放后的预览

验收：拖入一张照片能看到 EXIF 字段（缺失字段不崩）。

### M2：模板系统 v1 + Canvas 渲染 + 单张导出（2–5 天）
- 定义模板 JSON（布局 + 字段映射 + 默认样式 + 版本号）
- Canvas 渲染：
  - 底图绘制（处理缩放、裁切、背景）
  - 信息块/文字绘制（对齐、行高、字距、阴影/描边可选）
  - 图标/分隔线（可选 v1.1）
- 导出：
  - PNG/JPEG（`canvas.toBlob`）
  - JPEG quality（用户可选）
  - 透明处理：JPEG 下用背景色填充
  - 明确提示：导出不包含 EXIF

验收：4 套模板可切换；导出图与预览一致。

### M3：批量处理（2–5 天）
- 任务队列：并发池、进度、失败重试
- 批量导出：逐张下载（v1）或 ZIP（可选 v1.5）
- 安全阈值：最大张数/最大像素提示与保护

验收：20 张照片批量导出可用，不会把页面卡死到不可操作。

### M4：PWA 离线（1–2 天）
- 添加 Service Worker precache
- 离线提示与更新策略（避免旧缓存）

验收：断网仍能打开应用并完成导入→导出。

### M5：HEIC/HEIF 支持（2–6 天，依赖选型）
- 原生解码优先；不支持则转码兜底
- 批量 HEIC 的内存与耗时控制

验收：至少在一组目标浏览器上可稳定导入 HEIC 并导出 JPEG/PNG。

### M6：性能工程化（可选，2–8 天）
- Worker + OffscreenCanvas
- 缩略图与懒加载（虚拟列表）
- 性能基准脚本与指标看板（简单即可）

---

## 7. 目录结构建议（框架无关）

- `src/`
  - `app/`（页面/路由）
  - `components/`（通用组件）
  - `core/`
    - `exif/`（读取与字段归一化）
    - `templates/`（模板定义、校验、升级）
    - `render/`（Canvas 或其他渲染实现）
    - `export/`（导出 PNG/JPEG、zip、命名规则）
    - `batch/`（队列、并发池、进度）
  - `workers/`（v2+）
  - `assets/`（内置模板资源、字体声明等）
- `public/`（静态资源、PWA 图标）
- `docs/`（隐私说明、模板规范、FAQ）

---

## 8. 风险清单（来自 init.md 的重点）

- HEIC：浏览器支持不一致 → “原生优先 + 转码兜底”并明确提示
- 用户预期：导出后看不到 EXIF → 在导出设置与结果提示中明确“导出图不含元数据（隐私友好）”
- 批量：高像素原片内存爆 → 并发池 + 缩略图 + 张数/像素保护 + Worker 化
- 兼容性：File System Access/OffscreenCanvas 等非全量支持 → 功能探测 + fallback

---

## 9. 下一步需要你确认的点（决定我把任务拆到多细）

你已经确定了 React + Canvas + PNG/JPEG（可调 quality）。下面给出**默认建议**（不需要你再选也能开工），如果你想改我再按你的偏好调整：

1) **PWA 离线**：先不进 v1（放到 M4；核心闭环稳定后再加）  
2) **批量导出**：v1 先“逐张下载”，v1.5 再加“ZIP 打包”（避免一开始就引入额外内存峰值）  
3) **HEIC**：v1 只支持“浏览器能原生解码的 HEIC”；解码失败就提示用户先转换为 JPEG（M5 再做转码兜底）

如果你希望 **v1 就做 ZIP / v1 就做 PWA / v1 就兜底 HEIC**，直接告诉我即可，我会把里程碑与依赖调整到位。

---

## 10. v1 任务拆分（建议直接按 issue 开工）

### 10.1 工程与 UI 骨架
- 初始化 Vite 项目（React + TS），补齐 `eslint/prettier` 与基础目录结构
- 做三栏布局：左（图片列表）/中（预览）/右（参数与导出）
- 做通用表单组件：`Select` / `Slider` / `Switch` / `Button` / `Toast`

### 10.2 核心数据模型（先定类型再写逻辑）
- `ExifData`：归一化后的字段（含缺失兜底）
- `TemplateV1`：模板 JSON（版本号、布局、字段映射、默认样式）
- `RenderRequest`：输入位图 + exif + 模板 + 用户参数
- `ExportOptions`：格式、quality、尺寸、文件命名、JPEG 背景色
- `BatchJob`：任务状态（排队/处理中/成功/失败）、进度、错误原因

### 10.3 EXIF 读取与归一化
- 接入 EXIF 库读取常用字段（时间、机身、镜头、焦段、快门、光圈、ISO）
- 处理 Orientation：保证预览与导出方向正确（避免“重复旋转”）
- 字段格式化：例如 `1/200s`、`f/1.8`、`ISO 800`、`24mm`

### 10.4 图片解码与预览管线
- 统一的 `decodeImage(file)`：优先 `createImageBitmap`，失败 fallback 到 `HTMLImageElement`
- 生成缩略图（用于左侧列表）与预览位图（用于中间预览）
- 控制内存：任务结束后释放位图引用（`ImageBitmap.close()` 若可用）

### 10.5 模板系统（v1 先“可控”，v3 再“可编辑”）
- 定义 `TemplateV1` schema（建议用 `zod`），加载内置模板 JSON
- 内置 4 套模板：信息密集/极简/胶片风/底部条（字段开关可配置）
- 用户参数覆盖：颜色、字号、边距、圆角、阴影、是否显示某字段

### 10.6 Canvas 渲染器（核心）
- 底图绘制：缩放/裁切策略（Contain/Cover 二选一，建议 v1 先 Cover）
- 信息块绘制：背景块、描边、分隔线、对齐
- 文本绘制：测量（`measureText`）、换行策略、溢出省略
- 输出：同一渲染器支持“预览尺寸”和“导出尺寸”

### 10.7 导出与下载
- PNG/JPEG 导出：`canvas.toBlob` + `download(blob, filename)`
- JPEG quality：右侧参数可调，默认 0.92
- 命名规则：最小可用 `{index}` + 原文件名；后续再加 `{date}`/`{camera}`
- 提示：导出结果不包含 EXIF（在导出面板与导出完成 toast 中提示）

### 10.8 批量队列（v1 先稳）
- 并发池：默认并发 1–2；支持暂停/继续/取消
- 进度：逐张状态 + 总进度；失败原因可见并可重试
- 批量导出：逐张下载（v1）；ZIP（v1.5 可选）

### 10.9 手工测试清单（每次发版前跑一遍）
- 方向：竖图/横图/倒置图（带 Orientation）预览与导出一致
- 字段：有 EXIF/无 EXIF/部分字段缺失都不崩且展示合理
- 导出：PNG/JPEG 都能导出；quality 调整对体积有明显影响
- 批量：20 张 12–24MP 不崩；失败可重试；取消后资源释放
